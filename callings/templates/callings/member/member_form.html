{% extends 'callings/base.html' %}

{% block title %}{% if form.instance.pk %}Edit{% else %}Create{% endif %} Member{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card">
                <div class="card-header">
                    <h2 class="mb-0">{% if form.instance.pk %}Edit{% else %}Create New{% endif %} Member</h2>
                </div>
                <div class="card-body">
                    <form method="post" class="needs-validation" novalidate enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <div class="row mb-4">
                            <div class="col-md-3 text-center">
                                <div class="mb-3">
                                    <div class="avatar-container mb-2">
                                        {% if form.instance.profile_picture %}
                                        <img id="profile-image-preview" src="{{ form.instance.profile_picture.url }}" 
                                             class="rounded-circle img-thumbnail" 
                                             style="width: 150px; height: 150px; object-fit: cover;">
                                        {% else %}
                                        <div id="profile-image-placeholder" 
                                             class="avatar-placeholder rounded-circle d-flex align-items-center justify-content-center mx-auto" 
                                             style="width: 150px; height: 150px; background-color: #f0f0f0; font-size: 3rem;">
                                            <i class="fas fa-user text-muted"></i>
                                        </div>
                                        <img id="profile-image-preview" 
                                             class="rounded-circle img-thumbnail d-none" 
                                             style="width: 150px; height: 150px; object-fit: cover;">
                                        {% endif %}
                                    </div>
                                    <div class="form-group">
                                        <label for="{{ form.profile_picture.id_for_label }}" class="btn btn-sm btn-outline-secondary">
                                            <i class="fas fa-upload"></i> Upload Photo
                                        </label>
                                        {{ form.profile_picture }}
                                        {% if form.profile_picture.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.profile_picture.errors.0 }}
                                            </div>
                                        {% endif %}
                                        {% if form.instance.profile_picture %}
                                        <div class="form-check mt-2">
                                            <input class="form-check-input" type="checkbox" name="profile_picture-clear" id="profile_picture-clear_id">
                                            <label class="form-check-label" for="profile_picture-clear_id">
                                                Remove
                                            </label>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-9">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.first_name.id_for_label }}" class="form-label">
                                            {{ form.first_name.label }} <span class="text-danger">*</span>
                                        </label>
                                        {{ form.first_name }}
                                        {% if form.first_name.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.first_name.errors.0 }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.last_name.id_for_label }}" class="form-label">
                                            {{ form.last_name.label }} <span class="text-danger">*</span>
                                        </label>
                                        {{ form.last_name }}
                                        {% if form.last_name.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.last_name.errors.0 }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.middle_name.id_for_label }}" class="form-label">
                                            {{ form.middle_name.label }}
                                        </label>
                                        {{ form.middle_name }}
                                        {% if form.middle_name.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.middle_name.errors.0 }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.suffix.id_for_label }}" class="form-label">
                                            {{ form.suffix.label }}
                                        </label>
                                        {{ form.suffix }}
                                        {% if form.suffix.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.suffix.errors.0 }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.gender.id_for_label }}" class="form-label">
                                            {{ form.gender.label }}
                                        </label>
                                        {{ form.gender }}
                                        {% if form.gender.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.gender.errors.0 }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.birth_date.id_for_label }}" class="form-label">
                                            {{ form.birth_date.label }}
                                        </label>
                                        {{ form.birth_date }}
                                        {% if form.birth_date.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.birth_date.errors.0 }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.unit.id_for_label }}" class="form-label">
                                            {{ form.unit.label }} <span class="text-danger">*</span>
                                        </label>
                                        {{ form.unit }}
                                        {% if form.unit.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.unit.errors.0 }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.membership_status.id_for_label }}" class="form-label">
                                            {{ form.membership_status.label }}
                                        </label>
                                        {{ form.membership_status }}
                                        {% if form.membership_status.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.membership_status.errors.0 }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <h5 class="mb-3">Contact Information</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.email.id_for_label }}" class="form-label">
                                    {{ form.email.label }}
                                </label>
                                {{ form.email }}
                                {% if form.email.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.email.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.phone.id_for_label }}" class="form-label">
                                    {{ form.phone.label }}
                                </label>
                                {{ form.phone }}
                                {% if form.phone.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.phone.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.address.id_for_label }}" class="form-label">
                                    {{ form.address.label }}
                                </label>
                                {{ form.address }}
                                {% if form.address.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.address.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="{{ form.city.id_for_label }}" class="form-label">
                                    {{ form.city.label }}
                                </label>
                                {{ form.city }}
                                {% if form.city.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.city.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="row">
                                    <div class="col-6">
                                        <label for="{{ form.state.id_for_label }}" class="form-label">
                                            {{ form.state.label }}
                                        </label>
                                        {{ form.state }}
                                        {% if form.state.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.state.errors.0 }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-6">
                                        <label for="{{ form.zip_code.id_for_label }}" class="form-label">
                                            {{ form.zip_code.label }}
                                        </label>
                                        {{ form.zip_code }}
                                        {% if form.zip_code.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.zip_code.errors.0 }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="{{ form.notes.id_for_label }}" class="form-label">
                                {{ form.notes.label }}
                            </label>
                            {{ form.notes }}
                            {% if form.notes.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.notes.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% if form.instance.pk %}{% url 'member-detail' form.instance.pk %}{% else %}{% url 'member-list' %}{% endif %}" 
                               class="btn btn-outline-secondary me-md-2">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> {% if form.instance.pk %}Update{% else %}Create{% endif %} Member
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.avatar-placeholder {
    border: 1px solid #dee2e6;
    color: #6c757d;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize form validation
    var forms = document.querySelectorAll('.needs-validation');
    
    // Loop over them and prevent submission
    Array.prototype.slice.call(forms).forEach(function(form) {
        form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            form.classList.add('was-validated');
        }, false);
    });
    
    // Handle profile picture preview
    const profilePictureInput = document.getElementById('{{ form.profile_picture.id_for_label }}');
    const profileImagePreview = document.getElementById('profile-image-preview');
    const profileImagePlaceholder = document.getElementById('profile-image-placeholder');
    
    if (profilePictureInput) {
        profilePictureInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (profileImagePreview) {
                        profileImagePreview.src = e.target.result;
                        profileImagePreview.classList.remove('d-none');
                        if (profileImagePlaceholder) {
                            profileImagePlaceholder.classList.add('d-none');
                        }
                    }
                };
                reader.readAsDataURL(file);
            }
        });
    }
    
    // Initialize date picker for birth date
    if (document.getElementById('{{ form.birth_date.id_for_label }}')) {
        // You can add a date picker initialization here if needed
        // Example with flatpickr:
        // flatpickr('#{{ form.birth_date.id_for_label }}', {
        //     dateFormat: "Y-m-d",
        //     allowInput: true
        // });
    }
    
    // Initialize phone input masking if needed
    if (document.getElementById('{{ form.phone.id_for_label }}')) {
        // You can add phone input masking here if needed
        // Example with inputmask:
        // Inputmask({"mask": "(999) 999-9999"}).mask('#{{ form.phone.id_for_label }}');
    }
});
</script>
{% endblock %}
